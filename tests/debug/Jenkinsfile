properties([
    parameters([
        [
            $class: 'CascadeChoiceParameter',
            name: 'SERVICES',
            description: 'Выберите сервисы (можно несколько из разных блоков)',
            choiceType: 'PT_CHECKBOX',  // Мультиселект
            script: [
                $class: 'GroovyScript',
                script: [
                    $class: 'SecureGroovyScript',
                    script: '''
                        return [
                            // Блок "DEV"
                            "<optgroup label='DEV'>",
                            "  frontend-dev",
                            "  backend-dev",
                            "  db-dev",
                            "</optgroup>",
                            
                            // Блок "PROD"
                            "<optgroup label='PROD'>",
                            "  frontend-prod",
                            "  backend-prod",
                            "  db-prod",
                            "</optgroup>",
                            
                            // Блок "STAGE"
                            "<optgroup label='STAGE'>",
                            "  frontend-stage",
                            "  backend-stage",
                            "  monitoring-stage",
                            "</optgroup>"
                        ]
                    ''',
                    sandbox: true
                ]
            ]
        ]
    ])
])

pipeline {
    agent any
    stages {
        stage('Run') {
            steps {
                script {
                    echo "Выбранные сервисы: ${params.SERVICES}"
                    if (params.SERVICES) {
                        params.SERVICES.each { service ->
                            echo "Обрабатываем: ${service.trim()}"  // trim() убирает лишние пробелы
                        }
                    }
                }
            }
        }
    }
}