properties([
    displayName('üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'),
    description('–°–±–æ—Ä–∫–∞ React-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è')
])
pipeline {
    agent { label "OneS" }

    parameters {
        choice(name: 'product', choices: ['Fitness_CORP', 'Stomatology'], description: '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç')
        string(defaultValue: "4.0.54.1", description: '–°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è', name: 'oldversion_1')
        string(defaultValue: "4.0.55.1", description: '–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è', name: 'newversion_1')
        string(defaultValue: "8.3.24.1368", description: '–í–µ—Ä—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã 1—Å', name: 'platformversion_1')
        string(defaultValue: "3.0.37.11710", description: '–í–µ—Ä—Å–∏—è –°–õ–ö', name: 'slkversion')
    }
	environment {
        FOLDERS_TEMP = "D:\\RELEASES\\${params.product}"
        FOLDERS_OLDVERSION = "${env.FOLDERS_TEMP}\\OldVersion"
        FOLDERS_SCRIPTS = "${env.FOLDERS_TEMP}\\Scripts"
        FOLDERS_PACKAGE = "${env.FOLDERS_TEMP}\\Package"
        FOLDERS_BUILD = "${env.FOLDERS_TEMP}\\Build"
        sample = "C:\\automation\\sample\\${params.product}"
        sampleEdf = "${env.WORKSPACE}\\BuildReleases\\edf\\${params.product}"
        target_path = "${env.FOLDERS_TEMP}\\${params.product}"
        packageFull = "${env.FOLDERS_PACKAGE}\\full"
        packageUpdate = "${env.FOLDERS_PACKAGE}\\updates"

    }
     stages {
        stage('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤') {
            steps {
                script {
                    if (params.product.equalsIgnoreCase('Fitness_CORP')) {
                        env.serie = "5415"
                        env.extNameMess = "–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä"
                        env.releaseBase = "VAFitness"
                        env.repository = "http://192.168.2.16/hran1c/repository.1ccr/fitness_release"
                        env.repositoryMess = "http://192.168.2.16/hran1c/repository.1ccr/fitness4_messenger_release"
                        env.buildBase = "FitnessCorpSborka"
                        env.buildUser = "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ë–î"
                        env.edfFull = "–ö–æ–º–ø–ª–µ–∫—Ç –ø–æ—Å—Ç–∞–≤–∫–∏.edf"
                        env.edfUpdate = "–§–∞–π–ª –æ–ø–∏—Å–∞–Ω–∏—è –∫–æ–º–ø–ª–µ–∫—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏.edf"
                        env.nameDistr = "Fitness"

                    } else if (params.product.equals('Stomatology')) {
                        env.serie = "4FB1"
                        env.extNameMess = "–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä_–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è"
                        env.extNameShedule = "–ñ—É—Ä–Ω–∞–ª–ó–∞–ø–∏—Å–∏_–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è"
                        env.releaseBase = "VAStoma"
                        env.repository = "http://192.168.2.16/hran1c/repository.1ccr/stomatology2_release"
                        env.repositoryMess = "http://192.168.2.16/hran1c/repository.1ccr/stomatology2_messenger_release"
                        env.repositoryShedule = "http://192.168.2.16/hran1c/repository.1ccr/stomatology2_shedule"
                        env.buildBase = "StomaSborka"
                        env.buildUser = "–ù–∏–∫–æ–ª–∞–µ–≤ –õ–µ–≤ (–ü–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∞)"
                        env.edfFull = "1–°_–ú–µ–¥–∏—Ü–∏–Ω–∞_21_–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π_–ö–æ–º–ø–ª–µ–∫—Ç–ü–æ—Å—Ç–∞–≤–∫–∏.edf"
                        env.edfUpdate = "–§–∞–π–ª –æ–ø–∏—Å–∞–Ω–∏—è –∫–æ–º–ø–ª–µ–∫—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏.edf"
                        env.nameDistr = "–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∫–ª–∏–Ω–∏–∫–∞"
                    } else {
                        error "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç: ${params.product}. –û–∂–∏–¥–∞–µ—Ç—Å—è 'Fitness' –∏–ª–∏ 'Stomatology'."
                    }
                }
            }
        }
        stage('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏') {
            steps {
                script {
                    sh "python -X utf8 BuildReleases/config/delete_folders_and_files.py \"${env.target_path}\" \"${env.FOLDERS_PACKAGE}\" \"${env.FOLDERS_BUILD}\""
                    sh "python -X utf8 BuildReleases/config/update_files_and_contents.py \"${env.sample}\" \"${env.target_path}\" \"${params.oldversion_1}\" \"${params.newversion_1}\" \"${params.platformversion_1}\" \"${params.slkversion}\" \"${env.FOLDERS_BUILD}\""
                    sh "python -X utf8 BuildReleases/config/process_files.py \"${params.oldversion_1}\" \"${params.newversion_1}\" \"${env.sampleEdf}\" \"${env.FOLDERS_SCRIPTS}\""
                }
            }
        }
        // stage("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ —Ä–µ–ª–∏–∑–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞") {
        //     steps{
        //         script {
        //             // –°–ï–ê–ù–°–´ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–´ –ë–ê–ó–ê - releaseBase
		// 			bat """
		// 			chcp 65001
		// 			@call vrunner session kill --db ${env.releaseBase} --db-user –ê–¥–º–∏–Ω --uccode BUILDER
		// 			@call vrunner loadrepo --storage-name ${env.repository} --storage-user ${env.VATest2} --ibconnection /Slocalhost/${env.releaseBase} --db-user –ê–¥–º–∏–Ω --uccode BUILDER
		// 			@call vrunner updatedb --ibconnection /Slocalhost/${env.releaseBase} --db-user –ê–¥–º–∏–Ω --uccode BUILDER
        //             """
        //         } 
        //     }
        // }
        // stage("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π") {
        //     steps{  
        //         echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞"
        //         script {
        //             bat """
        //             chcp 65001
        //             @call vrunner loadrepo --storage-name ${env.repositoryMess} --storage-user –ú–∏—Ö–∞–∏–ª–ë --extension ${env.extNameMess} --ibconnection /Slocalhost/${env.releaseBase} --db-user –ê–¥–º–∏–Ω --uccode BUILDER
        //             @call vrunner updateext ${env.extNameMess} --ibconnection /Slocalhost/${env.releaseBase} --db-user –ê–¥–º–∏–Ω --uccode BUILDER
        //             """
        //         }
        //         echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ –∑–∞–ø–∏—Å–∏"
        //         script{
        //             if (params.product == 'Stomatology'){
        //                 bat """
        //                 chcp 65001
        //                 @call vrunner loadrepo --storage-name ${env.repositoryShedule} --storage-user –ú–∏—Ö–∞–∏–ª–ë --extension ${env.extNameShedule} --ibconnection /Slocalhost/${env.releaseBase} --db-user –ê–¥–º–∏–Ω --uccode BUILDER
        //                 @call vrunner updateext ${env.extNameShedule} --ibconnection /Slocalhost/${env.releaseBase} --db-user –ê–¥–º–∏–Ω --uccode BUILDER
        //                 """
        //             } else{
        //                 echo "–®–∞–≥ 2 –ø—Ä–æ–ø—É—â–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –Ω–µ –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è"
        //             }
        //         }
        //     }
        // }
        // stage("–í—ã–≥—Ä—É–∑–∫–∞ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞") {
        //     steps{
        //         echo "–í—ã–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
        //         script {
        //             bat """
        //             chcp 65001
        //             @call vrunner unload ${env.FOLDERS_SCRIPTS}\\1Cv8.cf --ibconnection /Slocalhost/${env.releaseBase} --db-user –ê–¥–º–∏–Ω --uccode BUILDER
        //             """
        //         }
        //         echo "–í—ã–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π"
        //         script{
        //             if (params.product == 'Stomatology') {
        //                 bat """
        //                 chcp 65001
        //                 @call vrunner unloadext ${env.FOLDERS_SCRIPTS}\\jurnal.cfe ${env.extNameShedule} --ibconnection /Slocalhost/${env.releaseBase} --db-user –ê–¥–º–∏–Ω --uccode BUILDER
        //                 """
		// 			} else{
        //                 echo "–®–∞–≥ –ø—Ä–æ–ø—É—â–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –Ω–µ –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è"
        //             }
        //             bat"""
        //             chcp 65001
        //             @call vrunner unloadext ${env.FOLDERS_SCRIPTS}\\messenger.cfe ${env.extNameMess} --ibconnection /Slocalhost/${env.releaseBase} --db-user –ê–¥–º–∏–Ω --uccode BUILDER
        //             @call vrunner session unlock --db ${env.releaseBase} --db-user –ê–¥–º–∏–Ω
        //             """
        //             // –°–ï–ê–ù–°–´ –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù–´
        //         }
        //     }
        // }
        // stage('–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è') {
        //     when { expression {params.product.contains('Stomatology') } }
        //     steps {
        //         script{
        //             bat """
        //             start ${env.FOLDERS_TEMP}\\Netlenka1C.exe --mode=prof --source ${env.FOLDERS_SCRIPTS}\\jurnal.cfe --createpdb
        //             exit
        //             """
        //         }
        //     }
        // }
        // stage('–ó–∞–≥—Ä—É–∑–∫–∞ .cf –≤ –±–∞–∑—É –¥–ª—è —Å–±–æ—Ä–∫–∏ —Ä–µ–ª–∏–∑–∞') {
        //     steps {
        //         script { 
        //             // –°–ï–ê–ù–°–´ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–´ –ë–ê–ó–ê - buildBase
        //             bat """
        //             chcp 65001
        //             @call vrunner session kill  --db ${env.buildBase} --db-user "${env.buildUser}" --uccode BUILDER
        //             @call vrunner load --src ${env.FOLDERS_SCRIPTS}\\1Cv8.cf --ibconnection /Slocalhost/${env.buildBase} --db-user "${env.buildUser}" --uccode BUILDER
        //             @call vrunner updatedb --ibconnection /Slocalhost/${env.buildBase} --db-user "${env.buildUser}" --uccode BUILDER
        //             """
        //         }   
        //     }
        // }
        // stage("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –≤ —Ä–µ–∂–∏–º–µ 1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ") {
        //     steps {
        //         script{
        //             bat """
        //             chcp 65001
        //             @call vrunner run --command –ó–∞–≤–µ—Ä—à–∏—Ç—å–†–∞–±–æ—Ç—É–°–∏—Å—Ç–µ–º—ã; --ibconnection /Slocalhost/${env.buildBase} --db-user "${env.buildUser}" --execute "${env.epfvrunner}\\–ó–∞–∫—Ä—ã—Ç—å–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ.epf" --uccode BUILDER
        //             @call vrunner run --ibconnection /Slocalhost/${env.buildBase} --db-user "${env.buildUser}" --execute "${env.epfvrunner}\\–£–±—Ä–∞—Ç—å–û–∫–Ω–æ–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏—è–ò–ë.epf" --uccode BUILDER
        //             @call vrunner session unlock --db ${env.buildBase} --db-user "${env.buildUser}"
        //             """
        //             // –°–ï–ê–ù–°–´ –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù–´
        //         }
        //     }
        // }
        // stage('–ü–∞—É–∑–∞') {
        //     steps {
        //        script{
        //            // def messageText = """–°–±–æ—Ä–∫–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å –≤–Ω–µ—à–Ω—é—é –æ–±—Ä–∞–±–æ—Ç–∫—É, —É–¥–∞–ª–∏—Ç—å Helix –∏ fresh, –≤—ã–≥—Ä—É–∑–∏—Ç—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä"""
        //           //  def response = httpRequest(url: "https://api.telegram.org/bot${env.botToken}/sendMessage?chat_id=${env.chatId}&text=${URLEncoder.encode(messageText, 'UTF-8')}")
        //             // –í—Ä—É—á–Ω—É—é –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞
        //             input '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞?'
        //         }
        //     }
        // }
        // stage("–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –∏ –°–õ–ö") {
        //     steps {
        //         script {
        //             def loadexmes = 'BuildReleases/config/loadext.py'
        //             def compiledatafile = 'BuildReleases/config/compiledatafile.py'
        //             def zip = 'BuildReleases/config/zip.py'
        //             def source_file
        //             def template_name
        //             if (params.product.contains('Stomatology')) {
        //                 echo "–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ –∑–∞–ø–∏—Å–∏"
        //                 source_file = "${env.FOLDERS_SCRIPTS}\\Protected\\jurnal.cfe"
        //                 template_name = "–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ–ñ—É—Ä–Ω–∞–ª–∞–ó–∞–ø–∏—Å–∏"
        //                 sh "python -X utf8 ${loadexmes} \"${source_file}\" \"${env.platformPath}\" \"${env.buildBase}\" \"${env.buildUser}\" \"${template_name}\""
                    
        //             }
        //             echo  "–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞"
        //             source_file = "${env.FOLDERS_SCRIPTS}\\messenger.cfe"
        //             template_name = "–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞"
        //             sh "python -X utf8 ${loadexmes} \"${source_file}\" \"${env.platformPath}\" \"${env.buildBase}\" \"${env.buildUser}\" \"${template_name}\""

        //             echo "–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –°–õ–ö –≤ –º–∞–∫–µ—Ç '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–°–õ–ö'"
        //             source_file = "${env.FOLDERS_SCRIPTS}\\licenceaddin-${params.slkversion}-template.zip"
        //             template_name = "–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–°–õ–ö"
        //             sh "python -X utf8 ${loadexmes} \"${source_file}\" \"${env.platformPath}\" \"${env.buildBase}\" \"${env.buildUser}\" \"${template_name}\""

        //             echo "–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ .datafile"
        //             sh "python -X utf8 ${compiledatafile} \"${env.FOLDERS_SCRIPTS}\" \"${env.serie}\""

        //             echo "–ó–∞–≥—Ä—É–∑–∫–∞ .datafile –≤ –º–∞–∫–µ—Ç '–û–±—ä–µ–∫—Ç—ã–°–õ–ö'"
        //             source_file = "${env.FOLDERS_SCRIPTS}\\${env.serie}.datafile"
        //             template_name = "–û–±—ä–µ–∫—Ç—ã–°–õ–ö"
        //             sh "python -X utf8 ${loadexmes} \"${source_file}\" \"${env.platformPath}\" \"${env.buildBase}\" \"${env.buildUser}\" \"${template_name}\""

        //             echo  "–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ 4FB1.zip"
        //             sh "python -X utf8 ${zip} \"${env.FOLDERS_SCRIPTS}\" \"${env.target_path}\" \"${env.serie}\""
        //         }
        //     }
        // }
        stage('–û—Å–Ω–æ–≤–Ω–∞—è –ø–æ—Å—Ç–∞–≤–∫–∞') {
            steps {
                script {
                   
                    //@call vrunner session kill --db ${env.buildBase} --db-user "${env.buildUser}" --uccode BUILDER
                    bat """
                    chcp 65001
                    "${env.platformPath}" DESIGNER /Slocalhost/${env.buildBase} /N"${env.buildUser}" /CreateDistributivePackage"${env.packageFull}" -File"${env.FOLDERS_SCRIPTS}\\${env.edfFull}" -PackageFileName setup.zip -Option"–û—Å–Ω–æ–≤–Ω–∞—è –ø–æ—Å—Ç–∞–≤–∫–∞"
                    """
                    def unzipping = 'BuildReleases/config/unzipping.py'                    // –†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ
                    bat "python -X utf8 ${unzipping} ${env.packageFull}"
                    def install = 'BuildReleases/config/install.py'                        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞
                    bat "python -X utf8 ${install} ${env.packageFull}"
                }
            }
        }//
        // stage("–í—ã–≥—Ä–∑–∫–∞ —Ñ–∞–π–ª–∞ .cfu") {
        //     steps {
        //         script{
        //             bat """
        //             chcp 65001
        //             "${env.platformPath}" DESIGNER /Slocalhost/${env.buildBase} /N"${env.buildUser}" /CreateDistributionFiles -cfufile ${env.FOLDERS_BUILD}\\Update\\1Cv8.cfu -f ${env.FOLDERS_OLDVERSION}\\${oldversion_1}.cf
        //             """
        //         }
        //     }
        // }
    //     stage('–ü–æ—Å—Ç–∞–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è') {
    //         steps {
    //             script {
    //                 bat """
    //                 chcp 65001
    //                 "${env.platformPath}" DESIGNER /Slocalhost/${env.buildBase} /N"${env.buildUser}" /CreateDistributivePackage"${env.packageUpdate}" -File"${env.FOLDERS_SCRIPTS}\\${env.edfUpdate}" -PackageFileName update.zip -Option"–ü–æ—Å—Ç–∞–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
    //                 """
    //                 def unzippingupdate = 'BuildReleases/config/unzippingupdate.py'           // –†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ
    //                 bat "python -X utf8 ${unzippingupdate} ${env.packageUpdate}"
    //                 def installupdate = 'BuildReleases/config/installupdate.py'               // –£—Å—Ç–∞–Ω–æ–≤–∫–∞
    //                 bat "python -X utf8 ${installupdate} ${env.packageUpdate}"
    //             }
    //         }
    //     }
    //     stage('–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞') {
    //         steps {
    //             script {
    //                 def perenos = 'BuildReleases/config/Perenos.py'
    //                 sh "python -X utf8 ${perenos} \"${newversion_1}\" \"${env.target_path}\" \"${env.packageFull}\" \"${env.FOLDERS_OLDVERSION}\" \"${packageUpdate}\" \"${env.FOLDERS_SCRIPTS}\" \"${params.product}\" \"${env.edfUpdate}\" \"${env.FOLDERS_TEMP}\" \"${env.nameDistr}\""
    //                 def messagefinish = "–°–±–æ—Ä–∫–∞ ¬´${params.product}¬ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
    //                 def response = httpRequest(url: "https://api.telegram.org/bot${env.botToken}/sendMessage?chat_id=${env.chatId}&text=${URLEncoder.encode(messagefinish, 'UTF-8')}"
    //                 )
    //             }
    //         }
    //     }
     }
}