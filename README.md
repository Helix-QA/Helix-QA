<h1>Покрытие тестов</h1>

<details>
<summary><h3>1С: Фитнес-клуб</h3></summary>
<svg width="1000" height="500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 500" style="background:white;">

  <!-- Фон (опционально) -->
  <rect width="1000" height="500" fill="white"/>

  <!-- Блок "Договоры" (фиолетовый) -->
  <rect x="50" y="200" width="200" height="80" rx="40" ry="40" fill="#bb86fc" stroke="#333" stroke-width="3"/>
  <text x="150" y="240" font-size="20" text-anchor="middle" fill="black" font-weight="bold">Договоры</text>

  <!-- Стрелка от "Договоры" к центральному разветвлению -->
  <line x1="250" y1="240" x2="320" y2="240" stroke="#333" stroke-width="4" marker-end="url(#arrow)"/>

  <!-- Центральное разветвление (невидимый узел для стрелок) -->
  <!-- Верхний синий блок "Создание и проверка справочников" -->
  <rect x="350" y="100" width="400" height="80" rx="40" ry="40" fill="#81d4fa" stroke="#333" stroke-width="3"/>
  <text x="550" y="140" font-size="20" text-anchor="middle" fill="black" font-weight="bold">
    <tspan x="550" dy="-10">Создание и проверка</tspan>
    <tspan x="550" dy="30">справочников</tspan>
  </text>

  <!-- Нижний синий блок "Создание и проверка документов" -->
  <rect x="350" y="300" width="400" height="80" rx="40" ry="40" fill="#81d4fa" stroke="#333" stroke-width="3"/>
  <text x="550" y="340" font-size="20" text-anchor="middle" fill="black" font-weight="bold">
    <tspan x="550" dy="-10">Создание и проверка</tspan>
    <tspan x="550" dy="30">документов</tspan>
  </text>

  <!-- Стрелки от центрального узла к синим блокам -->
  <path d="M320 240 Q 335 140 350 140" stroke="#333" stroke-width="4" fill="none" marker-end="url(#arrow)"/>
  <path d="M320 240 Q 335 340 350 340" stroke="#333" stroke-width="4" fill="none" marker-end="url(#arrow)"/>

  <!-- Зелёный блок "Заполнение организации" (верхний правый) -->
  <rect x="800" y="80" width="350" height="80" rx="40" ry="40" fill="#a7ffeb" stroke="#333" stroke-width="3"/>
  <text x="975" y="120" font-size="20" text-anchor="middle" fill="black" font-weight="bold">
    <tspan x="975" dy="-10">Заполнение</tspan>
    <tspan x="975" dy="30">организации</tspan>
  </text>

  <!-- Зелёный блок "Заполнение структурной единицы" (нижний правый) -->
  <rect x="800" y="280" width="400" height="80" rx="40" ry="40" fill="#a7ffeb" stroke="#333" stroke-width="3"/>
  <text x="1000" y="320" font-size="20" text-anchor="middle" fill="black" font-weight="bold">
    <tspan x="1000" dy="-10">Заполнение структурной</tspan>
    <tspan x="1000" dy="30">единицы</tspan>
  </text>

  <!-- Стрелки от верхнего синего блока к зелёным (ветвление) -->
  <line x1="750" y1="140" x2="800" y2="140" stroke="#333" stroke-width="4"/>
  <path d="M800 140 Q 825 120 850 120" stroke="#333" stroke-width="4" fill="none" marker-end="url(#arrow)"/>
  <path d="M800 140 Q 825 320 850 320" stroke="#333" stroke-width="4" fill="none" marker-end="url(#arrow)"/>

  <!-- Определение стрелки -->
  <defs>
    <marker id="arrow" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto-start-reverse">
      <path d="M0,0 L0,12 L12,6 z" fill="#333"/>
    </marker>
  </defs>

</svg>
</details>

<details>
<summary><h3>1С: Стоматологическая клиника</h3></summary>

</details>

<details>
<summary><h3>1С: Салон красоты</h3></summary>

</details>


<details>
<summary><h1>Автоматическое тестирование </h1></summary>

Автоматическое тестирование продукта перед выпуском релиза для обеспечения качества.

## Файлы

Файлы хранятся в папке `tests`:

| Папка/Файл                        | Описание                                                                 |
|-----------------------------------|--------------------------------------------------------------------------|
| `Jenkinsfile`                     | Основной файл запуска Jenkins, адаптированный для трёх продуктов: «Фитнес-клуб», «Салон красоты», «Стоматология». |
| `tools/VAParams.json`             | Настройки для Vanessa Automation.                                        |
| `scripts/AgentRestart.py`         | Перезапускает службу агента сервера 1С.                                 |
| `scripts/drop_db.py`              | Удаляет базу данных из кластера 1С и PostgreSQL.                         |
| `scripts/InitDatabase.bat`        | Запускает функции `vrunner` для инициализации базы.                      |
| `notifications/allure-notifications-4.8.0.jar` | Формирует отчёт Allure и отправляет его в Telegram.                     |
| `notifications/config.json`        | Настройки отчёта Allure и отправки сообщений в Telegram.                 |
| `notifications/logo.png`           | Логотип продукта в отчёте Allure.                                       |
| `features/`                       | Наборы тестов для Vanessa Automation.                                   |
| `epf/`                            | Обработки для тестирования.                                             |
| `cfe/`                            | Расширения конфигурации.                                                |
| `build/`                          | Результаты отчётов Allure.                                              |

## Запуск

Процесс полностью автоматизирован. Запуск выполняется через **Jenkins** для продуктов:

- **fitness** (Фитнес-клуб)
- **salon** (Салон красоты)
- **stoma** (Стоматология)

Агент выполнения (`OneS`) находится на сервере 71.

### Настройка расписания

Тестирование выполняется автоматически в **20:00** по МСК. Для активации периодического запуска в настройках Pipeline продукта включите опцию «Запускать периодически» и укажите расписание: `H 20 * * *`.

![Настройка расписания](docs/trigger.jpg)

## Принцип работы

### 1. Подготовка базы данных

1. Удаление существующей базы данных (при её наличии).
2. Создание новой пустой базы.
3. Загрузка файла `.dt` в новую базу.
4. Обновление конфигурации базы данных.
5. Загрузка данных из релизного хранилища.
6. Повторное обновление конфигурации.

В случае ошибки на любом этапе процесс повторяется до двух раз. При повторной ошибке перезапускается агент сервера 1С, после чего подготовка базы повторяется ещё два раза.

Если база успешно создана и заполнена, проверяется версия релиза:

- Если версия совпадает с текущей в файле `D:\Vanessa-Automation\version`, продолжается выполнение Pipeline.
- Если версия релиза выше, запускаются обработчики обновления, а эталонная база выгружается и заменяется новой версией.

![Процесс подготовки базы](docs/pipeline.jpg)

### 2. Сценарное тестирование

1. Отключение пользователей от базы данных.
2. Выполнение тестов с использованием Vanessa Automation.

### 3. Формирование и отправка отчёта Allure

- Проверяется стабильность результатов тестирования.
- Если результат стабилен или нестабилен, отчёт Allure отправляется в Telegram.
- В противном случае отчёт не отправляется.

![Пример отчёта Allure](docs/allure.jpg)

### 4. Дымовые тесты

#### - **Планируемые этапы**

- **Syntax-check**: Автоматическая проверка синтаксиса кода.
- **SonarQube**: Анализ качества кода с использованием платформы SonarQube.

## Рабочие каталоги

На сервере 71 в папке `D:\Vanessa-Automation` хранятся файлы эталонных баз и информация о версиях.

![Этапы выполнения](docs/build.jpg)

</details>